<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#f5f4f0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="×—×“×©×•×ª IL">
<link rel="manifest" href="/manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<title>×—×“×©×•×ª ×™×©×¨××œ</title>
<style>
:root {
  --bg:#f5f4f0;--bg2:#eeecea;--bg3:#e5e3de;
  --card:#ffffff;--card2:#faf9f7;
  --border:rgba(0,0,0,0.07);--shadow:0 2px 12px rgba(0,0,0,0.06);
  --text:#1a1917;--text2:#6b6860;--text3:#a09d98;
  --red:#dc2626;--orange:#ea580c;--green:#16a34a;--blue:#2563eb;
  --r:16px;--f:'Heebo',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:var(--f);background:var(--bg);color:var(--text);max-width:480px;margin:0 auto;padding-bottom:80px;min-height:100vh;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:0;height:0}
#header{position:sticky;top:0;z-index:50;background:rgba(245,244,240,0.97);backdrop-filter:blur(16px);border-bottom:1px solid var(--border)}
.h-top{display:flex;justify-content:space-between;align-items:center;padding:12px 16px 10px}
.logo{display:flex;align-items:center;gap:10px}
.logo-name{font-size:17px;font-weight:900;color:var(--text);letter-spacing:-0.5px}
.logo-name em{color:var(--red);font-style:normal}
.live-pill{display:flex;align-items:center;gap:5px;background:var(--red);border-radius:20px;padding:3px 9px;font-size:10px;font-weight:800;color:#fff;letter-spacing:0.5px}
.live-dot{width:6px;height:6px;border-radius:50%;background:#fff;animation:blink 1s infinite}
#clock-time{font-size:16px;font-weight:700;color:var(--text);font-variant-numeric:tabular-nums;text-align:left}
#clock-date{font-size:10px;color:var(--text3);text-align:left}
#alert-banner{display:none;margin:0 12px 10px;padding:12px 14px;background:var(--red);border-radius:12px;animation:ablink 1s ease-in-out infinite}
#alert-banner.show{display:flex;align-items:center;gap:10px}
.ab-icon{font-size:22px;animation:shake 0.4s infinite}
.ab-title{font-size:13px;font-weight:900;color:#fff}
.ab-areas{font-size:11px;color:rgba(255,255,255,0.85);margin-top:2px}
@keyframes ablink{0%,100%{opacity:1}50%{opacity:0.85}}
@keyframes shake{0%,100%{transform:rotate(0)}30%{transform:rotate(-8deg)}70%{transform:rotate(8deg)}}
.ticker{display:flex;align-items:center;gap:8px;padding:6px 16px;background:var(--text);overflow:hidden}
.ticker-lbl{font-size:9px;font-weight:900;color:var(--red);background:#fee2e2;padding:2px 6px;border-radius:4px;white-space:nowrap;letter-spacing:1px;flex-shrink:0}
#ticker-text{font-size:12px;color:rgba(255,255,255,0.85);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;transition:opacity 0.3s}
.tabs{display:flex;border-bottom:1px solid var(--border)}
.tab-btn{flex:1;padding:10px 0;border:none;cursor:pointer;background:transparent;font-size:12px;font-weight:600;color:var(--text3);border-bottom:2px solid transparent;transition:all 0.2s;font-family:var(--f);display:flex;align-items:center;justify-content:center;gap:5px}
.tab-btn.active{color:var(--red);border-bottom-color:var(--red);font-weight:800}
.panel{display:none}.panel.active{display:block}
#status-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:var(--card2);border-bottom:1px solid var(--border)}
#status-text{font-size:11px;color:var(--text3);flex:1}
#refresh-btn{padding:5px 12px;border-radius:20px;background:var(--text);border:none;color:#fff;font-size:11px;cursor:pointer;font-weight:700;font-family:var(--f)}
.src-scroll{display:flex;gap:6px;padding:10px 16px;overflow-x:auto;scrollbar-width:none;background:var(--card2);border-bottom:1px solid var(--border)}
.src-btn{padding:5px 13px;border-radius:20px;border:1.5px solid var(--border);cursor:pointer;background:var(--card);color:var(--text2);font-size:11px;white-space:nowrap;flex-shrink:0;font-family:var(--f);font-weight:600;transition:all 0.15s}
#news-list{padding:12px}
.section-hdr{display:flex;align-items:center;gap:8px;padding:4px 4px 10px;font-size:10px;font-weight:800;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px}
.section-line{flex:1;height:1px;background:var(--border)}
.news-card{display:block;text-decoration:none;color:inherit;background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:14px 15px 13px 14px;margin-bottom:8px;position:relative;overflow:hidden;box-shadow:var(--shadow);transition:transform 0.12s,box-shadow 0.12s}
.news-card:active{transform:scale(0.99);box-shadow:none}
.news-card::before{content:'';position:absolute;top:0;right:0;bottom:0;width:3px;border-radius:0 var(--r) var(--r) 0;background:var(--src-color,#ddd)}
.news-card.breaking{background:linear-gradient(135deg,#fff5f5 0%,#fff 60%);border-color:rgba(220,38,38,0.2)}
.card-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;gap:8px}
.src-tag{display:flex;align-items:center;gap:4px;font-size:11px;font-weight:800;padding:2px 8px;border-radius:6px;white-space:nowrap}
.card-time{font-size:11px;color:var(--text3);white-space:nowrap;display:flex;align-items:center;gap:4px}
.new-pill{background:var(--green);color:#fff;font-size:9px;font-weight:800;padding:1px 5px;border-radius:4px}
.card-title{font-size:14px;font-weight:700;line-height:1.55;color:var(--text)}
.news-card.breaking .card-title{color:var(--red)}
.card-desc{font-size:12px;color:var(--text2);line-height:1.5;margin-top:5px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.empty{text-align:center;padding:48px 20px;color:var(--text3)}
.alerts-wrap{padding:14px}
.oref-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;display:flex;align-items:center;gap:12px;margin-bottom:12px;box-shadow:var(--shadow)}
.oref-dot2{width:12px;height:12px;border-radius:50%;flex-shrink:0;background:var(--green);box-shadow:0 0 0 3px rgba(22,163,74,0.15);animation:breathe 2s ease-in-out infinite}
.oref-dot2.red{background:var(--red);box-shadow:0 0 0 3px rgba(220,38,38,0.15)}
.oref-dot2.grey{background:var(--text3);box-shadow:none;animation:none}
@keyframes breathe{0%,100%{transform:scale(1)}50%{transform:scale(1.3)}}
.oref-lbl{font-size:12px;font-weight:700;color:var(--text);flex:1}
.oref-sub2{font-size:10px;color:var(--text3);margin-top:1px}
#oref-time{font-size:10px;color:var(--text3)}
#alert-box{border-radius:var(--r);padding:24px 20px;margin-bottom:14px;text-align:center;border:1.5px solid rgba(22,163,74,0.3);background:linear-gradient(135deg,#f0fdf4,#fff);transition:all 0.4s}
#alert-box.danger{background:linear-gradient(135deg,#fee2e2,#fef2f2);border-color:rgba(220,38,38,0.4);animation:dangerPulse 1.2s ease-in-out infinite}
@keyframes dangerPulse{0%,100%{box-shadow:0 0 0 0 rgba(220,38,38,0.2)}50%{box-shadow:0 0 0 8px rgba(220,38,38,0)}}
#alert-emoji{font-size:48px;margin-bottom:8px}
#alert-status{font-size:18px;font-weight:900;color:var(--green)}
#alert-box.danger #alert-status{color:var(--red)}
#alert-areas{font-size:14px;color:var(--red);margin-top:10px;line-height:2;font-weight:700}
.alert-sub{font-size:10px;color:var(--text3);margin-top:8px;display:flex;align-items:center;justify-content:center;gap:6px}
.oref-chip{background:rgba(22,163,74,0.1);border:1px solid rgba(22,163,74,0.2);border-radius:4px;padding:1px 6px;font-size:9px;font-weight:700;color:var(--green)}
.safety-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.safety-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 12px;text-align:center;box-shadow:var(--shadow)}
.hist-lbl{font-size:11px;font-weight:800;color:var(--text2);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px}
.hist-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 14px;margin-bottom:7px;display:flex;justify-content:space-between;align-items:center;box-shadow:var(--shadow)}
.hist-loc{font-size:12px;font-weight:700;color:var(--text)}
.hist-type2{font-size:10px;color:var(--text3);margin-top:2px}
.hist-t{font-size:11px;font-weight:700;color:var(--text2);text-align:left}
#alert-overlay{display:none;position:fixed;inset:0;z-index:999;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);align-items:center;justify-content:center}
#alert-overlay.show{display:flex}
.alert-modal{background:#fff;border-radius:24px;padding:32px 28px;text-align:center;width:88%;max-width:340px;border-top:5px solid var(--red);box-shadow:0 24px 64px rgba(220,38,38,0.25);animation:modalIn 0.3s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes modalIn{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}
.modal-areas{font-size:15px;color:var(--red);margin-top:10px;line-height:1.9;font-weight:700}
.modal-warn{margin-top:14px;padding:10px 16px;background:#fee2e2;border-radius:10px;font-size:12px;font-weight:700;color:var(--red)}
.modal-btn{margin-top:18px;width:100%;padding:13px;border-radius:14px;border:none;background:var(--red);color:#fff;font-size:14px;font-weight:800;cursor:pointer;font-family:var(--f)}
.settings-wrap{padding:14px}
.s-sec{margin-bottom:20px}
.s-sec-ttl{font-size:11px;font-weight:800;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.s-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;box-shadow:var(--shadow)}
.s-row{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)}
.s-row:last-child{border-bottom:none}
.s-row.col{flex-direction:column;align-items:flex-start;gap:10px}
.s-lbl{font-size:14px;font-weight:600;color:var(--text)}
.s-sub2{font-size:11px;color:var(--text3);margin-top:2px}
.toggle{width:46px;height:26px;border-radius:13px;background:var(--bg3);border:none;cursor:pointer;position:relative;transition:all 0.2s;flex-shrink:0}
.toggle.on{background:var(--green)}
.toggle::after{content:'';position:absolute;top:3px;right:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,0.2);transition:all 0.2s}
.toggle.on::after{right:23px}
.vol-slider{width:100%;accent-color:var(--red);cursor:pointer;height:4px}
.test-btn{width:100%;padding:12px;border-radius:12px;background:var(--bg2);border:1.5px solid var(--border);color:var(--text);font-size:13px;font-weight:700;cursor:pointer;font-family:var(--f);margin-top:6px}
.notif-btn{width:100%;padding:14px;border-radius:14px;background:var(--text);border:none;color:#fff;font-size:14px;font-weight:800;cursor:pointer;font-family:var(--f);margin-bottom:10px}
#bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;z-index:100;background:rgba(245,244,240,0.97);border-top:1px solid var(--border);display:flex;backdrop-filter:blur(16px);padding-bottom:env(safe-area-inset-bottom)}
.nav-btn{flex:1;padding:10px 0;border:none;cursor:pointer;background:transparent;font-size:10px;font-weight:600;color:var(--text3);display:flex;flex-direction:column;align-items:center;gap:3px;font-family:var(--f);position:relative;transition:color 0.15s}
.nav-btn.active{color:var(--red);font-weight:800}
.nav-icon{font-size:21px;line-height:1}
.nav-badge{position:absolute;top:7px;right:calc(50% - 16px);width:8px;height:8px;border-radius:50%;background:var(--green);border:2px solid var(--bg)}
.nav-badge.alert{background:var(--red);animation:blink 0.8s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
.spin{display:inline-block;animation:spin 0.6s linear infinite}
</style>
</head>
<body>

<div id="alert-overlay">
  <div class="alert-modal">
    <div style="font-size:56px">ğŸš¨</div>
    <div style="font-size:24px;font-weight:900;color:var(--red);margin-top:6px">××–×¢×§×”!</div>
    <div id="overlay-type" style="font-size:15px;font-weight:600;color:var(--text2);margin-top:4px"></div>
    <div class="modal-areas" id="overlay-areas"></div>
    <div class="modal-warn">âš ï¸ ×”×™×›× ×¡×• ×œ××¨×—×‘ ××•×’×Ÿ ××™×™×“×™×ª!</div>
    <button class="modal-btn" onclick="dismissOverlay()">×”×‘× ×ª×™ â€” × ×›× ×¡×ª×™ ×œ××¨×—×‘ ××•×’×Ÿ</button>
  </div>
</div>

<div id="header">
  <div class="h-top">
    <div class="logo">
      <span style="font-size:22px">ğŸ‡®ğŸ‡±</span>
      <span class="logo-name">×—×“×©×•×ª <em>LIVE</em></span>
      <div class="live-pill"><span class="live-dot"></span>×©×™×“×•×¨</div>
    </div>
    <div>
      <div id="clock-time">00:00</div>
      <div id="clock-date"></div>
    </div>
  </div>
  <div id="alert-banner">
    <div class="ab-icon">ğŸš¨</div>
    <div><div class="ab-title">××–×¢×§×” ×¤×¢×™×œ×”!</div><div class="ab-areas" id="banner-areas"></div></div>
  </div>
  <div class="ticker"><span class="ticker-lbl">××‘×–×§</span><span id="ticker-text">××ª×—×‘×¨...</span></div>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('news',this)">ğŸ“° ×—×“×©×•×ª</button>
    <button class="tab-btn" onclick="switchTab('alerts',this)">ğŸš¨ ××–×¢×§×•×ª</button>
    <button class="tab-btn" onclick="switchTab('settings',this)">âš™ï¸ ×”×’×“×¨×•×ª</button>
  </div>
</div>

<div id="panel-news" class="panel active">
  <div id="status-bar">
    <span id="status-text"><span class="spin">âŸ³</span> ×˜×•×¢×Ÿ...</span>
    <button id="refresh-btn" onclick="loadNews(true)">âŸ³ ×¨×¢× ×Ÿ</button>
  </div>
  <div class="src-scroll" id="src-tabs"></div>
  <div id="news-list"><div class="empty"><div style="font-size:48px">ğŸ“¡</div><p style="margin-top:10px;font-weight:600">×˜×•×¢×Ÿ ×—×“×©×•×ª...</p></div></div>
</div>

<div id="panel-alerts" class="panel">
  <div class="alerts-wrap">
    <div class="oref-card">
      <div class="oref-dot2 grey" id="oref-dot"></div>
      <div><div class="oref-lbl">×¤×™×§×•×“ ×”×¢×•×¨×£</div><div class="oref-sub2">×‘×“×™×§×” ×›×œ 5 ×©× ×™×•×ª â€¢ oref.org.il</div></div>
      <div id="oref-time">--:--</div>
    </div>
    <div id="alert-box">
      <div id="alert-emoji">âœ…</div>
      <div id="alert-status">××™×Ÿ ××–×¢×§×•×ª ×›×¨×’×¢</div>
      <div id="alert-areas"></div>
      <div class="alert-sub"><span class="oref-chip">â— oref.org.il</span><span>××ª×¢×“×›×Ÿ ×›×œ 5 ×©× ×™×•×ª</span></div>
    </div>
    <div class="safety-grid">
      <div class="safety-card"><div style="font-size:26px">ğŸƒ</div><div style="font-size:11px;color:var(--text2);margin-top:4px">×‘× ×™×™×Ÿ ×¨×’×™×œ</div><div style="font-size:16px;font-weight:900;color:#ca8a04;margin-top:4px">90 ×©× '</div></div>
      <div class="safety-card"><div style="font-size:26px">ğŸ </div><div style="font-size:11px;color:var(--text2);margin-top:4px">×‘×™×ª ×¤×¨×˜×™</div><div style="font-size:16px;font-weight:900;color:var(--orange);margin-top:4px">60 ×©× '</div></div>
      <div class="safety-card"><div style="font-size:26px">ğŸŒ³</div><div style="font-size:11px;color:var(--text2);margin-top:4px">×©×˜×— ×¤×ª×•×—</div><div style="font-size:16px;font-weight:900;color:var(--red);margin-top:4px">30 ×©× '</div></div>
      <div class="safety-card"><div style="font-size:26px">ğŸš—</div><div style="font-size:11px;color:var(--text2);margin-top:4px">×¨×›×‘</div><div style="font-size:16px;font-weight:900;color:#7c3aed;margin-top:4px">×¢×¦×•×¨ ×•×©×›×‘</div></div>
    </div>
    <div class="hist-lbl">××–×¢×§×•×ª ××—×¨×•× ×•×ª</div>
    <div id="alert-history"><div class="empty" style="padding:16px"><div style="font-size:11px">×˜×•×¢×Ÿ...</div></div></div>
  </div>
</div>

<div id="panel-settings" class="panel">
  <div class="settings-wrap">
    <div class="s-sec">
      <div class="s-sec-ttl">×”×ª×¨××•×ª</div>
      <button class="notif-btn" onclick="reqNotif()">×”×¤×¢×œ ×”×ª×¨××•×ª ××”×“×¤×“×¤×Ÿ ğŸ””</button>
      <div class="s-card">
        <div class="s-row"><div><div class="s-lbl">×¦×œ×™×œ ××–×¢×§×”</div><div class="s-sub2">×¦×¤×™×¨×” ×›×©×™×© ××–×¢×§×”</div></div><div class="toggle on" id="t-sound" onclick="tog('sound')"></div></div>
        <div class="s-row"><div><div class="s-lbl">×•×™×‘×¨×¦×™×”</div><div class="s-sub2">×¨×˜×˜ ×‘××›×©×™×¨</div></div><div class="toggle on" id="t-vibrate" onclick="tog('vibrate')"></div></div>
        <div class="s-row col"><div class="s-lbl">×¢×•×¦××ª ×§×•×œ</div><input type="range" min="0" max="100" value="80" class="vol-slider" id="vol-slider" oninput="setVol(this.value)"></div>
      </div>
      <button class="test-btn" onclick="testAlert()">ğŸ”Š ×‘×“×•×§ ×¦×œ×™×œ ××–×¢×§×”</button>
    </div>
    <div class="s-sec">
      <div class="s-sec-ttl">×¢×“×›×•× ×™×</div>
      <div class="s-card">
        <div class="s-row"><div><div class="s-lbl">×¨×¢× ×•×Ÿ ××•×˜×•××˜×™</div><div class="s-sub2">×—×“×©×•×ª ×•××–×¢×§×•×ª ×›×œ 5 ×©× ×™×•×ª</div></div><div class="toggle on" id="t-auto" onclick="tog('auto')"></div></div>
      </div>
    </div>
    <div style="text-align:center;padding:16px 0 4px;font-size:11px;color:var(--text3)">
      ×—×“×©×•×ª ×™×©×¨××œ LIVE v2.2<br>
      <span style="color:var(--text3)">ynet â€¢ ×•×•××œ×” â€¢ ×›××Ÿ 11 â€¢ ×¢×¨×•×¥ 12 â€¢ ×¢×¨×•×¥ 13 â€¢ ×¢×¨×•×¥ 14 â€¢ ×××§×• â€¢ ××¢×¨×™×‘ â€¢ ×“×•×‘×¨ ×¦×‘×</span>
    </div>
  </div>
</div>

<div id="bottom-nav">
  <button class="nav-btn active" id="nav-news" onclick="switchTab('news',null)"><span class="nav-icon">ğŸ“°</span>×—×“×©×•×ª</button>
  <button class="nav-btn" id="nav-alerts" onclick="switchTab('alerts',null)"><div class="nav-badge" id="alert-dot"></div><span class="nav-icon">ğŸš¨</span>××–×¢×§×•×ª</button>
  <button class="nav-btn" id="nav-settings" onclick="switchTab('settings',null)"><span class="nav-icon">âš™ï¸</span>×”×’×“×¨×•×ª</button>
</div>

<script>
const S=JSON.parse(localStorage.getItem('ns2')||'{}');
const SD={sound:true,vibrate:true,auto:true};
const gs=k=>k in S?S[k]:SD[k];
const ss=(k,v)=>{S[k]=v;localStorage.setItem('ns2',JSON.stringify(S))};
function tog(k){const v=!gs(k);ss(k,v);const el=document.getElementById('t-'+k);if(el)v?el.classList.add('on'):el.classList.remove('on');if(k==='auto')v?startAuto():stopAuto()}
['sound','vibrate','auto'].forEach(k=>{const el=document.getElementById('t-'+k);if(el)gs(k)?el.classList.add('on'):el.classList.remove('on')});

let allItems=[],currentSrc='all',hasAlert=false,tickIdx=0,autoTimer=null,vol=0.8,lastAlertKey='',orefFails=0,loading=false;

function tick(){const n=new Date();document.getElementById('clock-time').textContent=n.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});document.getElementById('clock-date').textContent=n.toLocaleDateString('he-IL',{weekday:'short',day:'numeric',month:'short'})}
tick();setInterval(tick,1000);

function rotateTicker(){if(!allItems.length)return;const el=document.getElementById('ticker-text');el.style.opacity='0';setTimeout(()=>{const item=allItems[tickIdx%Math.min(allItems.length,60)];if(item)el.textContent=item.sourceIcon+' '+item.title;el.style.opacity='1';tickIdx++},300)}
setInterval(rotateTicker,6000);

function switchTab(tab,btn){document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));document.getElementById('panel-'+tab).classList.add('active');if(btn)btn.classList.add('active');const m={news:'nav-news',alerts:'nav-alerts',settings:'nav-settings'};if(m[tab])document.getElementById(m[tab]).classList.add('active')}

const CH={
  ynet:{name:'ynet',color:'#E8001E',icon:'ğŸ“°'},
  ynet_war:{name:'ynet ××œ×—××”',color:'#b30000',icon:'ğŸ”´'},
  walla:{name:'×•×•××œ×”',color:'#FF6B00',icon:'ğŸ”¥'},
  walla_war:{name:'×•×•××œ×” ×‘×™×˜×—×•×Ÿ',color:'#cc5500',icon:'âš”ï¸'},
  maariv:{name:'××¢×¨×™×‘',color:'#0891B2',icon:'ğŸ—ï¸'},
  kan:{name:'×›××Ÿ 11',color:'#2563EB',icon:'ğŸ™ï¸'},
  ch12:{name:'×¢×¨×•×¥ 12',color:'#C8102E',icon:'ğŸ“º'},
  ch13:{name:'×¢×¨×•×¥ 13',color:'#7C3AED',icon:'ğŸ“¡'},
  ch14:{name:'×¢×¨×•×¥ 14',color:'#d97706',icon:'ğŸ¦…'},
  mako:{name:'×××§×•',color:'#e11d48',icon:'ğŸ¬'},
  idf:{name:'×“×•×‘×¨ ×¦×‘×',color:'#166534',icon:'ğŸª–'}
};

function renderSrcTabs(){const el=document.getElementById('src-tabs');const sources=['all',...new Set(allItems.map(i=>i.source))];el.innerHTML='';sources.forEach(id=>{const ch=id==='all'?{name:'×”×›×œ',color:'#1a1917',icon:'ğŸŒ'}:(CH[id]||{name:id,color:'#6b7280',icon:'ğŸ“°'});const b=document.createElement('button');b.className='src-btn'+(id===currentSrc?' active':'');b.textContent=ch.icon+' '+ch.name;if(id===currentSrc){b.style.background=ch.color;b.style.color='#fff';b.style.borderColor=ch.color;}b.onclick=()=>{currentSrc=id;renderSrcTabs();renderList()};el.appendChild(b)})}

const seenIds=new Set();
function renderList(){
  const list=document.getElementById('news-list');
  const filtered=currentSrc==='all'?allItems:allItems.filter(n=>n.source===currentSrc);
  if(!filtered.length){list.innerHTML='<div class="empty"><div style="font-size:40px">ğŸ“­</div><p style="margin-top:8px;font-weight:600">××™×Ÿ ×›×ª×‘×•×ª ×›×¨×’×¢</p></div>';return}
  list.innerHTML='';
  const hdr=document.createElement('div');
  hdr.className='section-hdr';
  const t=new Date().toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});
  hdr.innerHTML=`<span class="section-line"></span><span>×¢×“×›×•×Ÿ ${t}</span><span class="section-line"></span>`;
  list.appendChild(hdr);
  filtered.forEach((item,idx)=>{
    const ch=CH[item.source]||{name:item.source,color:'#6b7280',icon:'ğŸ“°'};
    const isNew=!seenIds.has(item.id);
    const isBreaking=idx===0&&currentSrc==='all';
    const a=document.createElement('a');
    a.className='news-card'+(isBreaking?' breaking':'');
    a.style.setProperty('--src-color',ch.color);
    a.href=item.link||'#';a.target='_blank';a.rel='noopener';
    a.style.animation=`fadeUp 0.18s ease ${Math.min(idx,15)*0.028}s both`;
    a.innerHTML=`<div class="card-meta"><span class="src-tag" style="background:${ch.color}12;color:${ch.color}">${ch.icon} ${ch.name}</span><span class="card-time">${item.timeAgo}${isNew?'&nbsp;<span class="new-pill">×—×“×©</span>':''}</span></div><div class="card-title">${item.title}</div>${item.desc?`<div class="card-desc">${item.desc}</div>`:''}`;
    list.appendChild(a);
    seenIds.add(item.id);
  });
}

async function loadNews(manual=false){
  if(loading&&!manual)return;loading=true;
  const btn=document.getElementById('refresh-btn');const status=document.getElementById('status-text');
  if(manual){btn.disabled=true;btn.innerHTML='<span class="spin">âŸ³</span>'}
  try{
    const res=await fetch('/api/news?t='+Date.now());const data=await res.json();
    if(data.items&&data.items.length>0){
      allItems=data.items;
      const t=new Date(data.updated).toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      status.textContent='×¢×•×“×›×Ÿ '+t+' â€¢ '+data.total+' ×›×ª×‘×•×ª';
      renderSrcTabs();renderList();rotateTicker();
    }
  }catch(e){if(manual)status.textContent='×©×’×™××ª ×—×™×‘×•×¨'}
  if(manual){btn.disabled=false;btn.innerHTML='âŸ³ ×¨×¢× ×Ÿ'}
  loading=false;
}
function startAuto(){stopAuto();if(gs('auto'))autoTimer=setInterval(()=>loadNews(false),5000)}
function stopAuto(){if(autoTimer){clearInterval(autoTimer);autoTimer=null}}
startAuto();

function setVol(v){vol=v/100}
document.getElementById('vol-slider').oninput=e=>setVol(e.target.value);
function playAlertSound(){
  if(!gs('sound'))return;
  try{const ctx=new(window.AudioContext||window.webkitAudioContext)();[[440,.13],[880,.13],[440,.13],[880,.13],[440,.13]].forEach(([f,d],i)=>{const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sawtooth';o.frequency.value=f;const t=ctx.currentTime+i*0.18;g.gain.setValueAtTime(vol*.4,t);g.gain.exponentialRampToValueAtTime(.001,t+d);o.start(t);o.stop(t+d)})}catch(e){}
}
function testAlert(){playAlertSound();if(gs('vibrate')&&navigator.vibrate)navigator.vibrate([200,100,200])}
async function reqNotif(){if(!('Notification'in window)){alert('×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×”×ª×¨××•×ª');return}const p=await Notification.requestPermission();alert(p==='granted'?'×”×ª×¨××•×ª ×”×•×¤×¢×œ×•!':'×× × ××©×¨ ×”×ª×¨××•×ª ×‘×”×’×“×¨×•×ª ×”×“×¤×“×¤×Ÿ')}

function setOrefUI(ok){const dot=document.getElementById('oref-dot');dot.className='oref-dot2'+(ok?'':' grey');document.getElementById('oref-time').textContent=new Date().toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}

async function checkAlerts(){
  try{const res=await fetch('/api/alerts?t='+Date.now());const text=await res.text();orefFails=0;setOrefUI(true);
    if(!text||text.trim()===''||text.trim()==='{}'){clearAlert();return}
    const data=JSON.parse(text);
    if(data&&data.data&&data.data.length>0)triggerAlert(data.data,data.title||'×™×¨×™ ×¨×§×˜×•×ª',data.data.join(','));
    else clearAlert();
  }catch(e){orefFails++;if(orefFails>=3){const dot=document.getElementById('oref-dot');dot.className='oref-dot2 grey'}}
}

function triggerAlert(areas,type,key){
  const str=Array.isArray(areas)?areas.join(' â€¢ '):areas;
  hasAlert=true;
  document.getElementById('alert-box').classList.add('danger');
  document.getElementById('alert-emoji').textContent='ğŸš¨';
  document.getElementById('alert-status').textContent='××–×¢×§×” ×¤×¢×™×œ×”!';
  document.getElementById('alert-areas').textContent=str;
  document.getElementById('alert-dot').classList.add('alert');
  document.getElementById('oref-dot').className='oref-dot2 red';
  document.getElementById('banner-areas').textContent=str;
  document.getElementById('alert-banner').classList.add('show');
  if(key!==lastAlertKey){
    lastAlertKey=key;
    document.getElementById('overlay-areas').textContent=str;
    document.getElementById('overlay-type').textContent=type;
    document.getElementById('alert-overlay').classList.add('show');
    playAlertSound();
    if(gs('vibrate')&&navigator.vibrate)navigator.vibrate([400,100,400,100,400,100,400]);
    if('Notification'in window&&Notification.permission==='granted')new Notification('××–×¢×§×” â€” '+type,{body:str,icon:'/icon-192.png'});
  }
}
function clearAlert(){if(!hasAlert)return;hasAlert=false;lastAlertKey='';document.getElementById('alert-box').classList.remove('danger');document.getElementById('alert-emoji').textContent='âœ…';document.getElementById('alert-status').textContent='××™×Ÿ ××–×¢×§×•×ª ×›×¨×’×¢';document.getElementById('alert-areas').textContent='';document.getElementById('alert-dot').classList.remove('alert');document.getElementById('alert-banner').classList.remove('show');document.getElementById('oref-dot').className='oref-dot2'}
function dismissOverlay(){document.getElementById('alert-overlay').classList.remove('show')}

async function loadHistory(){
  try{const res=await fetch('/api/alerts/history');const data=await res.json();const el=document.getElementById('alert-history');
    if(!Array.isArray(data)||!data.length){el.innerHTML='<div class="empty" style="padding:14px;font-size:11px">××™×Ÿ ××–×¢×§×•×ª ×”×™×•×</div>';return}
    el.innerHTML=data.slice(0,10).map(a=>`<div class="hist-card"><div><div class="hist-loc">${a.cities||(Array.isArray(a.data)?a.data.join(', '):'')||'â€”'}</div><div class="hist-type2">${a.alertHeader||a.title||''}</div></div><div class="hist-t">${a.alertDate?new Date(a.alertDate).toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'}):''}</div></div>`).join('');
  }catch(e){}
}

if('serviceWorker'in navigator)navigator.serviceWorker.register('/sw.js');
loadNews(true);
checkAlerts();setInterval(checkAlerts,5000);
loadHistory();setInterval(loadHistory,30000);
</script>
</body>
</html>
